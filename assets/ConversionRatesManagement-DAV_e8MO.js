import{r as i,j as e,C as F,b as k,c as L,d as M,e as T,A as H,a as A,n as G,B as W,k as R,l as P,z,D as I,E as _,g as Y,F as q,G as J,H as K,I as Q}from"./index-BIXGV2mp.js";import{T as X,a as Z,b as V,c as U}from"./tabs-xekSAAra.js";const ee=()=>{const[n,l]=i.useState(""),[x,g]=i.useState(!1),[c,u]=i.useState(!1),[j,r]=i.useState([]),[o,b]=i.useState(null),[s,v]=i.useState(null);i.useEffect(()=>{(async()=>{try{const m=await R(),p=await P();b(m),v(p)}catch(m){console.error("Error loading conversion factors:",m)}})()},[]);const N=(h,m="pending")=>{r(p=>[...p,{step:h,status:m,timestamp:new Date().toISOString()}])},y=h=>{r(m=>{const p=[...m];return p.length>0&&(p[p.length-1].status=h),p})},E=async()=>{u(!0),l("Starting migration..."),r([]),g(!1);try{if(N("Initializing conversion factors structure"),await z(),y("complete"),N("Verifying broiler conversion factor"),!await I.getConversionFactorById("broilerMeatConversion"))throw new Error("Broiler conversion factor not found");if(y("complete"),N("Verifying country chicken conversion factor"),!await I.getConversionFactorById("countryChickenMeatConversion"))throw new Error("Country chicken conversion factor not found");y("complete"),N("Verifying conversion factor history");const p=await I.getAllConversionFactorHistory();y("complete"),N("Generating migration report");const B=await R(),C=await P(),D={timestamp:new Date().toISOString(),broilerFactor:B,countryFactor:C,historyEntries:p.length};console.log("Migration report:",D),y("complete"),b(B),v(C),l("Migration completed successfully. All data is now using the document-based conversion factor system."),g(!0)}catch(h){console.error("Migration error:",h),y("failed"),l(`Migration failed: ${h.message}`),g(!1)}finally{u(!1)}};return e.jsxs(F,{children:[e.jsxs(k,{children:[e.jsx(L,{children:"Conversion Factors Migration"}),e.jsx(M,{children:"Migrate existing data to use the document-based conversion factor system"})]}),e.jsx(T,{children:e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"bg-blue-50 p-4 rounded-lg space-y-2",children:[e.jsx("h3",{className:"font-semibold text-blue-800",children:"Migration Information"}),e.jsx("p",{className:"text-sm text-blue-700",children:"This tool will help ensure all data in the system uses the new document-based conversion factors structure instead of the old fixed values."}),e.jsx("p",{className:"text-sm text-blue-700",children:"Current conversion factors:"}),e.jsxs("ul",{className:"list-disc pl-5 text-sm text-blue-700",children:[e.jsxs("li",{children:["Broiler meat conversion: ",o||"Loading..."]}),e.jsxs("li",{children:["Country chicken meat conversion: ",s||"Loading..."]})]})]}),j.length>0&&e.jsxs("div",{className:"border rounded-md overflow-hidden",children:[e.jsx("div",{className:"bg-gray-50 px-4 py-2 border-b",children:e.jsx("h3",{className:"font-medium",children:"Migration Progress"})}),e.jsx("ul",{className:"divide-y",children:j.map((h,m)=>e.jsxs("li",{className:"px-4 py-2 flex items-center justify-between",children:[e.jsx("span",{children:h.step}),e.jsx("span",{className:`text-sm px-2 py-1 rounded-full ${h.status==="complete"?"bg-green-100 text-green-800":h.status==="failed"?"bg-red-100 text-red-800":"bg-yellow-100 text-yellow-800"}`,children:h.status==="complete"?"Complete":h.status==="failed"?"Failed":"In Progress"})]},m))})]}),n&&e.jsx(H,{className:x?"bg-green-50":"bg-amber-50",children:e.jsx(A,{children:n})})]})}),e.jsx(G,{className:"flex justify-end space-x-2",children:e.jsx(W,{onClick:E,disabled:c,className:"bg-blue-600 hover:bg-blue-700",children:c?"Migrating...":"Run Migration"})})]})},te=()=>{const[n,l]=i.useState([]),[x,g]=i.useState("all"),[c,u]=i.useState("all");i.useEffect(()=>{j()},[]);const j=async()=>{const s=await _();l(s)},r=s=>{g(s)},o=s=>{u(s)},b=n==null?void 0:n.filter(s=>!(x!=="all"&&(x==="broiler"&&!s.id.startsWith("broiler")||x==="country"&&!s.id.startsWith("country"))||c!=="all"&&(c==="meat"&&!s.id.includes("Meat")||c==="withSkin"&&!s.id.includes("WithSkin")||c==="withoutSkin"&&!s.id.includes("WithoutSkin"))));return e.jsxs(F,{className:"w-full",children:[e.jsxs(k,{children:[e.jsx(L,{children:"Conversion Factor History"}),e.jsx(M,{children:"Historical record of all conversion factor changes"})]}),e.jsxs(T,{children:[e.jsxs("div",{className:"flex flex-col gap-3 mb-4",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"text-sm font-medium mb-2",children:"Chicken Type"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{onClick:()=>r("all"),className:`px-3 py-1 text-xs rounded-md ${x==="all"?"bg-blue-600 text-white":"bg-gray-200 text-gray-700 hover:bg-gray-300"}`,children:"All Types"}),e.jsx("button",{onClick:()=>r("broiler"),className:`px-3 py-1 text-xs rounded-md ${x==="broiler"?"bg-blue-600 text-white":"bg-gray-200 text-gray-700 hover:bg-gray-300"}`,children:"Broiler Only"}),e.jsx("button",{onClick:()=>r("country"),className:`px-3 py-1 text-xs rounded-md ${x==="country"?"bg-blue-600 text-white":"bg-gray-200 text-gray-700 hover:bg-gray-300"}`,children:"Country Only"})]})]}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-sm font-medium mb-2",children:"Product Type"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{onClick:()=>o("all"),className:`px-3 py-1 text-xs rounded-md ${c==="all"?"bg-blue-600 text-white":"bg-gray-200 text-gray-700 hover:bg-gray-300"}`,children:"All Products"}),e.jsx("button",{onClick:()=>o("meat"),className:`px-3 py-1 text-xs rounded-md ${c==="meat"?"bg-blue-600 text-white":"bg-gray-200 text-gray-700 hover:bg-gray-300"}`,children:"Meat Only"}),e.jsx("button",{onClick:()=>o("withSkin"),className:`px-3 py-1 text-xs rounded-md ${c==="withSkin"?"bg-blue-600 text-white":"bg-gray-200 text-gray-700 hover:bg-gray-300"}`,children:"With Skin Only"}),e.jsx("button",{onClick:()=>o("withoutSkin"),className:`px-3 py-1 text-xs rounded-md ${c==="withoutSkin"?"bg-blue-600 text-white":"bg-gray-200 text-gray-700 hover:bg-gray-300"}`,children:"Without Skin Only"})]})]})]}),b.length>0?e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"w-full border-collapse",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"bg-gray-50 border-b",children:[e.jsx("th",{className:"px-4 py-2 text-left text-sm font-medium text-gray-500",children:"Factor"}),e.jsx("th",{className:"px-4 py-2 text-left text-sm font-medium text-gray-500",children:"Value"}),e.jsx("th",{className:"px-4 py-2 text-left text-sm font-medium text-gray-500",children:"Changed By"}),e.jsx("th",{className:"px-4 py-2 text-left text-sm font-medium text-gray-500",children:"Date"}),e.jsx("th",{className:"px-4 py-2 text-left text-sm font-medium text-gray-500",children:"Notes"})]})}),e.jsx("tbody",{children:b.map((s,v)=>e.jsxs("tr",{className:`border-b ${s.isCurrent?"bg-blue-50":""}`,children:[e.jsxs("td",{className:"px-4 py-3 text-sm",children:[e.jsx("div",{className:"font-medium",children:s.name}),e.jsx("div",{className:"text-xs text-gray-500",children:s.id})]}),e.jsx("td",{className:"px-4 py-3 text-sm font-medium",children:s.value}),e.jsx("td",{className:"px-4 py-3 text-sm",children:s.modifiedBy||"System"}),e.jsx("td",{className:"px-4 py-3 text-sm",children:new Date(s.timestamp).toLocaleString()}),e.jsx("td",{className:"px-4 py-3 text-sm",children:s.notes||"-"})]},`${s.id}-${s.timestamp}-${v}`))})]})}):e.jsx("div",{className:"text-center py-8 text-gray-500",children:"No history data available matching the selected filters."}),(n==null?void 0:n.length)>0&&e.jsxs("div",{className:"mt-4 text-xs text-gray-500",children:[e.jsxs("p",{children:["Showing ",b.length," of ",n.length," history entries",x!=="all"&&` (filtered by ${x})`,c!=="all"&&` (filtered by ${c})`]}),e.jsx("p",{className:"mt-1 italic",children:"Current values are highlighted in blue"})]})]})]})},se=()=>{const[n,l]=i.useState([]),[x,g]=i.useState(!0),[c,u]=i.useState(null);i.useEffect(()=>{(async()=>{try{g(!0);const o=await _();l(o),u(null)}catch(o){console.error("Error loading conversion factor history:",o),u("Failed to load conversion factor history"),l([])}finally{g(!1)}})()},[]);const j=r=>r?new Date(r).toLocaleDateString("en-US",{month:"short",day:"numeric",year:"numeric",hour:"2-digit",minute:"2-digit"}):"";return x?e.jsxs(F,{children:[e.jsxs(k,{children:[e.jsx(L,{children:"Conversion Factor History"}),e.jsx(M,{children:"Loading history data..."})]}),e.jsx(T,{className:"min-h-[200px] flex items-center justify-center",children:e.jsx("div",{className:"animate-pulse text-gray-400",children:"Loading conversion factor history..."})})]}):c?e.jsxs(F,{children:[e.jsxs(k,{children:[e.jsx(L,{children:"Conversion Factor History"}),e.jsx(M,{children:"Error loading history"})]}),e.jsx(T,{className:"min-h-[200px] flex items-center justify-center",children:e.jsx("div",{className:"text-red-500",children:c})})]}):e.jsxs(F,{children:[e.jsxs(k,{children:[e.jsx(L,{children:"Conversion Factor History"}),e.jsx(M,{children:"Track changes to conversion factors over time"})]}),e.jsx(T,{children:e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"min-w-full divide-y divide-gray-200",children:[e.jsx("thead",{className:"bg-gray-50",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Date"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Factor"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Value"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Changed By"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Notes"})]})}),e.jsxs("tbody",{className:"bg-white divide-y divide-gray-200",children:[n.map(r=>e.jsxs("tr",{className:r.isCurrent?"bg-blue-50":"",children:[e.jsx("td",{className:"px-6 py-4 whitespace-nowrap text-sm text-gray-500",children:j(r.timestamp)}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900",children:e.jsxs("div",{className:"flex flex-col",children:[e.jsx("span",{children:r.name}),e.jsx("span",{className:`text-xs ${r.category==="broiler"?"text-blue-600":"text-green-600"}`,children:r.category==="broiler"?"Broiler":"Country Chicken"})]})}),e.jsxs("td",{className:"px-6 py-4 whitespace-nowrap text-sm text-gray-900 font-medium",children:[r.value,r.isCurrent&&e.jsx("span",{className:"ml-2 text-xs text-blue-600",children:"(Current)"})]}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap text-sm text-gray-500",children:r.modifiedBy||"System"}),e.jsx("td",{className:"px-6 py-4 text-sm text-gray-500",children:r.notes||"-"})]},`${r.id}-${r.timestamp}`)),n.length===0&&e.jsx("tr",{children:e.jsx("td",{colSpan:"5",className:"px-6 py-4 text-center text-sm text-gray-500",children:"No history data available."})})]})]})})})]})},w=[{id:"broilerMeatConversion",name:"Broiler Meat Conversion",value:1.45,description:"Live weight to meat weight ratio for broiler chicken",category:"broiler"},{id:"broilerWithSkinConversion",name:"Broiler With Skin Conversion",value:1.25,description:"Live weight to with-skin weight ratio for broiler chicken",category:"broiler"},{id:"broilerWithoutSkinConversion",name:"Broiler Without Skin Conversion",value:1.35,description:"Live weight to without-skin weight ratio for broiler chicken",category:"broiler"}],S=[{id:"countryMeatConversion",name:"Country Chicken Meat Conversion",value:1.65,description:"Live weight to meat weight ratio for country chicken",category:"country"},{id:"countryWithSkinConversion",name:"Country Chicken With Skin Conversion",value:1.45,description:"Live weight to with-skin weight ratio for country chicken",category:"country"},{id:"countryWithoutSkinConversion",name:"Country Chicken Without Skin Conversion",value:1.55,description:"Live weight to without-skin weight ratio for country chicken",category:"country"}],ie=()=>{const[n,l]=i.useState([]),[x,g]=i.useState(""),[c,u]=i.useState(""),[j,r]=i.useState(!1),[o,b]=i.useState("broiler"),[s,v]=i.useState(!0),[N,y]=i.useState(!1),{currentUser:E}=i.useContext(Y)||{currentUser:null};i.useEffect(()=>{(async()=>{try{await z(),await h()}catch(a){console.error("Error initializing conversion factors:",a),y(!0),v(!1),l(o==="broiler"?w:S)}})()},[]),i.useEffect(()=>{(async()=>{try{await m(o)}catch(a){console.error(`Error loading ${o} factors:`,a),l(o==="broiler"?w:S)}})()},[o]);const h=async()=>{v(!0);try{const t=await q();if(!t||t.length===0)l(w);else{const a=t.filter(f=>f.category===o);a.length>0?l(a):l(o==="broiler"?w:S)}y(!1)}catch(t){console.error("Error loading conversion factors:",t),y(!0),l(o==="broiler"?w:S)}finally{v(!1)}},m=async t=>{v(!0);try{const a=await J(t);!a||a.length===0?l(t==="broiler"?w:S):l(a),y(!1)}catch(a){console.error(`Error loading ${t} factors:`,a),y(!0),l(t==="broiler"?w:S)}finally{v(!1)}},p=(t,a)=>{const f=parseFloat(a);isNaN(f)||f<=0||l(d=>d.map($=>$.id===t?{...$,value:f}:$))},B=async t=>{if(t.preventDefault(),s){u("Please wait for factors to load before saving"),r(!1);return}for(const d of n)if(isNaN(parseFloat(d.value))||parseFloat(d.value)<=0){u(`Invalid value for ${d.name}. Please enter a positive number.`),r(!1);return}const a=(E==null?void 0:E.username)||"Admin";let f=!1;try{for(const d of n)await K(d.id,d.value,a,x.trim()||`Updated ${d.name} conversion factor`)&&(f=!0);f?(u("Conversion factors updated successfully!"),r(!0),g(""),await m(o)):(u("No changes were detected in the conversion factors."),r(!0))}catch(d){console.error("Error saving conversion factors:",d),u("Error saving conversion factors: "+d.message),r(!1)}setTimeout(()=>{j&&u("")},3e3)},C=()=>{if(!n||n.length===0)return null;const t=n.reduce((a,f)=>{const d=new Date(f.updatedAt||0);return d>a?d:a},new Date(0));return t.getTime()===0?null:t},D=t=>s?e.jsx("div",{className:"py-8 text-center text-gray-500",children:"Loading conversion factors..."}):N?e.jsxs("div",{className:"py-8",children:[e.jsx(H,{className:"bg-red-50",children:e.jsx(A,{children:"Error loading conversion factors. Using default values."})}),e.jsx("div",{className:"mt-4 grid grid-cols-1 md:grid-cols-3 gap-4",children:n.map(a=>O(a,t))})]}):e.jsx(e.Fragment,{children:n.length===0?e.jsx("div",{className:"py-8 text-center text-gray-500",children:"No conversion factors found. Please reinitialize the system."}):e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:n.map(a=>O(a,t))})}),O=(t,a)=>{const f=a==="broiler"?"text-blue-700":"text-green-700";return e.jsx("div",{className:"bg-white p-4 rounded-lg border",children:e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("h3",{className:`font-medium ${f}`,children:t.name}),t.updatedAt&&e.jsxs("span",{className:"text-xs text-gray-500",children:["Last updated: ",new Date(t.updatedAt).toLocaleString()]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(Q,{type:"number",step:"0.01",min:"0.1",value:t.value,onChange:d=>p(t.id,d.target.value),className:"mt-1"}),e.jsx("p",{className:"text-xs text-gray-500",children:t.description})]}),t.history&&t.history.length>0&&e.jsxs("div",{className:"text-xs text-gray-500",children:["Previous value: ",t.history[0].value,"(changed ",new Date(t.history[0].timestamp).toLocaleDateString(),")"]})]})},t.id)};return e.jsxs(e.Fragment,{children:[e.jsxs(F,{children:[e.jsxs(k,{children:[e.jsx(L,{children:"Conversion Factors Management"}),e.jsx(M,{children:"Configure the conversion factors used throughout the application"})]}),e.jsxs(T,{children:[e.jsxs(X,{value:o,onValueChange:b,children:[e.jsxs(Z,{className:"grid w-full grid-cols-2 mb-6",children:[e.jsx(V,{value:"broiler",children:"Broiler Chicken"}),e.jsx(V,{value:"country",children:"Country Chicken"})]}),e.jsx(U,{value:"broiler",children:e.jsxs("form",{onSubmit:B,className:"space-y-6",children:[e.jsxs("div",{className:"space-y-6",children:[D("broiler"),e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{className:"text-sm font-medium",children:"Change Notes (Optional)"}),e.jsx("textarea",{value:x,onChange:t=>g(t.target.value),placeholder:"Reason for changing conversion factors",className:"w-full px-3 py-2 border rounded-md h-24"}),e.jsx("p",{className:"text-xs text-gray-500",children:"This will be recorded in the history for reference."})]})]}),c&&e.jsx(H,{className:j?"bg-green-50":"bg-red-50",children:e.jsx(A,{children:c})}),e.jsxs("div",{className:"flex justify-end gap-4",children:[e.jsx("div",{className:"flex-1 text-xs text-gray-500 my-auto",children:C()&&e.jsxs("span",{children:["Last updated: ",C().toLocaleString()]})}),e.jsx(W,{type:"submit",className:"px-6",disabled:s,children:s?"Loading...":"Save Broiler Conversion Factors"})]})]})}),e.jsx(U,{value:"country",children:e.jsxs("form",{onSubmit:B,className:"space-y-6",children:[e.jsxs("div",{className:"space-y-6",children:[D("country"),e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{className:"text-sm font-medium",children:"Change Notes (Optional)"}),e.jsx("textarea",{value:x,onChange:t=>g(t.target.value),placeholder:"Reason for changing conversion factors",className:"w-full px-3 py-2 border rounded-md h-24"}),e.jsx("p",{className:"text-xs text-gray-500",children:"This will be recorded in the history for reference."})]})]}),c&&e.jsx(H,{className:j?"bg-green-50":"bg-red-50",children:e.jsx(A,{children:c})}),e.jsxs("div",{className:"flex justify-end gap-4",children:[e.jsx("div",{className:"flex-1 text-xs text-gray-500 my-auto",children:C()&&e.jsxs("span",{children:["Last updated: ",C().toLocaleString()]})}),e.jsx(W,{type:"submit",className:"px-6",disabled:s,children:s?"Loading...":"Save Country Chicken Conversion Factors"})]})]})})]}),e.jsxs("div",{className:"bg-blue-50 p-4 rounded-lg space-y-2 mt-6",children:[e.jsx("h3",{className:"font-semibold text-blue-800",children:"How Conversion Works"}),e.jsxs("div",{className:"text-sm text-blue-700",children:[e.jsxs("p",{children:[e.jsx("strong",{children:"Example:"})," If conversion factor is 1.45 and live weight is 1.45kg, meat weight will be 1kg"]}),e.jsxs("p",{className:"mt-1",children:[e.jsx("strong",{children:"Formula:"})," Processed Weight = Live Weight รท Conversion Factor"]}),e.jsx("p",{className:"mt-2",children:e.jsx("strong",{children:"Different conversion factors allow for:"})}),e.jsxs("ul",{className:"list-disc pl-5 mt-1",children:[e.jsx("li",{children:"More accurate pricing for different product types"}),e.jsx("li",{children:"Accounting for different yields between broiler and country chicken"}),e.jsx("li",{children:"Proper inventory management for each product type"})]})]})]})]})]}),e.jsxs("div",{className:"mt-6 grid grid-cols-1 md:grid-cols-2 gap-6",children:[e.jsx(se,{}),e.jsx(te,{})]}),e.jsx("div",{className:"mt-6",children:e.jsx(ee,{})})]})};export{ie as default};
